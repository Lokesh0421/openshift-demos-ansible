---
# Common Facts

# set openshift master
- name: get openshift master
  shell: "oc whoami --show-server"
  register: openshift_master_result
  when: openshift_master is not defined

- name: set openshift master fact
  set_fact:
    openshift_master: "{{ openshift_master_result.stdout }}"
  when: openshift_master is not defined

- name: set openshift cli options
  set_fact:
    openshift_cli: "oc --server={{ openshift_master }} --insecure-skip-tls-verify=true"
  
# set kube config
- name: check if kube config dir exists
  stat:
    path: "{{ oc_kube_config }}"
  register: kube_config_result
  when: >
    oc_kube_config is defined and 
    oc_kube_config is not none and 
    oc_kube_config|trim() != ""

- name: set openshift cli options
  set_fact:
    openshift_cli: "{{ openshift_cli }} --config={{ oc_kube_config }}"
  when: > 
    oc_kube_config is defined and
    oc_kube_config is not none and 
    oc_kube_config|trim() != "" and
    kube_config_result.stat.exists and
    kube_config_result.stat.isdir

# set auth token
- name: set openshift cli options
  set_fact:
    openshift_cli: "{{ openshift_cli }} --token={{ oc_token }}"
  when: oc_token is defined
  when: >
    oc_token is defined and 
    oc_token is not none and 
    oc_token|trim() != ""

# set hostname suffix
- import_tasks: hostname_suffix.yml
  when: set_hostname_suffix